<!doctype html>
<html lang="fr">
  <head>
    <script>
      // Prevent navbar flash by setting class before render
      document.documentElement.classList.add("has-header-page");
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inscriptions - Backyard Ultra Valais</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Red+Hat+Text:ital,wght@0,300..700;1,300..700&family=Rubik+Dirt&family=Russo+One&family=Shippori+Antique&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
      integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="../css/index_style.css" />
    <link rel="stylesheet" href="../css/informations_style.css" />
    <link rel="stylesheet" href="../css/inscriptions_style.css" />
    <link
      rel="shortcut icon"
      href="../images/favicon.ico"
      type="image/x-icon"
    />
  </head>
  <body class="has-header inscriptions-page">
    <nav class="navbar">
      <div class="container">
        <div class="logo">
          <a href="/">
            <img src="../images/buv.png" alt="logo" />
          </a>
        </div>

        <!--Hamburger button-->
        <button id="hamburger-button" class="hamburger-button">
          <div class="hamburger-line"></div>
          <div class="hamburger-line"></div>
          <div class="hamburger-line"></div>
        </button>

        <div class="main-menu">
          <ul>
            <li>
              <a href="/">Accueil</a>
            </li>
            <li>
              <a href="/informations">Informations</a>
            </li>
            <li class="has-submenu">
              <a
                href="#"
                class="parent-link"
                aria-haspopup="true"
                aria-expanded="false"
                >Résultats</a
              >
              <ul class="dropdown-menu">
                <li><a href="/resultats/2025">2025</a></li>
                <li><a href="/resultats/2026">2026</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a
                href="#"
                class="parent-link"
                aria-haspopup="true"
                aria-expanded="false"
                >Photos</a
              >
              <ul class="dropdown-menu">
                <li><a href="/photos/2025">2025</a></li>
                <li><a href="/photos/2026">2026</a></li>
              </ul>
            </li>
            <li>
              <a href="/about-us">Notre Equipe</a>
            </li>
            <li>
              <a href="/sponsors">Partenaires</a>
            </li>
            <li class="social-nav">
              <a
                href="https://www.instagram.com/backyard.ultra.valais/"
                target="_blank"
                rel="noopener noreferrer"
                class="social-icon"
              >
                <i class="fab fa-instagram"></i>
              </a>
              <a
                href="https://www.facebook.com/profile.php?id=61566704801123"
                target="_blank"
                rel="noopener noreferrer"
                class="social-icon"
              >
                <i class="fab fa-facebook"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Mobile menu - outside navbar to avoid transparency inheritance -->
    <div class="mobile-menu">
      <button class="close-menu-button">&times;</button>
      <ul>
        <li>
          <a href="/">Accueil</a>
        </li>
        <li>
          <a href="/informations">Informations</a>
        </li>
        <li class="has-submenu">
          <a
            href="#"
            class="parent-link"
            aria-haspopup="true"
            aria-expanded="false"
            >Résultats</a
          >
          <ul class="dropdown-menu">
            <li><a href="/resultats/2025">2025</a></li>
            <li><a href="/resultats/2026">2026</a></li>
          </ul>
        </li>
        <li class="has-submenu">
          <a
            href="#"
            class="parent-link"
            aria-haspopup="true"
            aria-expanded="false"
            >Photos</a
          >
          <ul class="dropdown-menu">
            <li><a href="/photos/2025">2025</a></li>
            <li><a href="/photos/2026">2026</a></li>
          </ul>
        </li>
        <li>
          <a href="/about-us">Notre Equipe</a>
        </li>
        <li>
          <a href="/sponsors">Partenaires</a>
        </li>
        <li class="social-mobile">
          <a
            href="https://www.instagram.com/backyard.ultra.valais/"
            target="_blank"
            rel="noopener noreferrer"
            class="social-icon"
          >
            <i class="fab fa-instagram"></i>
          </a>
          <a
            href="https://www.facebook.com/profile.php?id=61566704801123"
            target="_blank"
            rel="noopener noreferrer"
            class="social-icon"
          >
            <i class="fab fa-facebook"></i>
          </a>
        </li>
      </ul>
    </div>

    <main class="inscriptions-fullscreen" role="main">
      <div class="blur-shell" aria-labelledby="inscriptions-title">
        <h1 id="inscriptions-title" class="page-head">Inscriptions 2026</h1>
        <p class="sub-head">Choisis ton format</p>
        <div class="formats-wrapper">
          <a
            href="#"
            class="inscription-format"
            data-img="../images/infinity.png"
            data-price="65"
            aria-disabled="true"
            tabindex="0"
          >
            <div class="format-content">
              <img
                src="../images/infinity.png"
                alt="Format Infinity"
                class="format-logo"
              />
              <h2>INFINITY <span class="format-by">by Baobab Energy</span></h2>
              <p>Boucles illimitées. Solo. Dernier debout.</p>
            </div>
          </a>
          <a
            href="#"
            class="inscription-format"
            data-img="../images/explorer.png"
            data-price="40"
            aria-disabled="true"
            tabindex="0"
          >
            <div class="format-content">
              <img
                src="../images/explorer.png"
                alt="Format Explorer"
                class="format-logo"
              />
              <h2>
                EXPLORER
                <span class="format-by">by Le Relais du Petit Bourg</span>
              </h2>
              <p>Format découverte sur nombre de boucles limité.</p>
            </div>
          </a>
        </div>
        <p class="soon-note"></p>
        <!-- Formulaire caché -->
        <div class="registration-form-wrapper" hidden>
          <button
            type="button"
            class="back-to-formats"
            aria-label="Retour aux formats"
          >
            ← Retour
          </button>
          <h2 class="form-title">
            Inscription <span class="selected-format-label"></span>
          </h2>
          <form id="inscription-form" action="#" method="post" novalidate>
            <input type="hidden" name="format" id="selected-format-input" />
            <!-- Honeypot anti-spam field (leave empty) -->
            <div
              style="
                position: absolute;
                left: -10000px;
                top: auto;
                width: 1px;
                height: 1px;
                overflow: hidden;
              "
            >
              <label for="hp">Ne pas remplir ce champ</label>
              <input
                id="hp"
                name="website"
                type="text"
                tabindex="-1"
                autocomplete="off"
              />
            </div>
            <div class="form-row two-cols">
              <div class="col">
                <label for="prenom">Prénom *</label>
                <input
                  id="prenom"
                  name="prenom"
                  type="text"
                  required
                  autocomplete="given-name"
                />
              </div>
              <div class="col">
                <label for="nom">Nom *</label>
                <input
                  id="nom"
                  name="nom"
                  type="text"
                  required
                  autocomplete="family-name"
                />
              </div>
            </div>
            <div class="form-row two-cols">
              <div class="col">
                <label for="email">Email *</label>
                <input
                  id="email"
                  name="email"
                  type="email"
                  required
                  autocomplete="email"
                />
              </div>
              <div class="col">
                <label for="phone">Numéro de téléphone *</label>
                <input
                  id="phone"
                  name="phone"
                  type="tel"
                  required
                  autocomplete="tel"
                  inputmode="tel"
                  placeholder="ex: +41 79 123 45 67"
                  pattern="^\+?[0-9\s\-()]{7,20}$"
                  title="Format attendu: +41 79 123 45 67 ou 079 123 45 67"
                />
              </div>
            </div>
            <fieldset class="form-row">
              <legend>Localisation</legend>
              <div class="form-row">
                <label for="pays">Pays *</label>
                <input id="pays" name="pays" type="text" required />
              </div>
              <div class="form-row two-cols">
                <div class="col">
                  <label for="canton">Canton</label>
                  <input id="canton" name="canton" type="text" />
                </div>
                <div class="col">
                  <label for="commune">Commune</label>
                  <input id="commune" name="commune" type="text" />
                </div>
              </div>
              <div class="form-row">
                <label
                  >Souhaites-tu afficher ton canton ou ta commune dans le
                  classement ? *</label
                >
                <div class="choices-inline">
                  <label
                    ><input
                      type="radio"
                      name="display_location"
                      value="Oui"
                      required
                    />
                    Oui</label
                  >
                  <label
                    ><input type="radio" name="display_location" value="Non" />
                    Non</label
                  >
                </div>
              </div>
            </fieldset>
            <div class="form-row">
              <label for="club">Club / Entreprise / Groupe (optionnel)</label>
              <input id="club" name="club" type="text" />
            </div>
            <div class="form-row">
              <label for="birthdate">Date de naissance *</label>
              <input id="birthdate" name="birthdate" type="date" required />
            </div>
            <fieldset class="form-row">
              <legend>Genre *</legend>
              <div class="choices-inline">
                <label
                  ><input type="radio" name="genre" value="Homme" required />
                  Homme</label
                >
                <label
                  ><input type="radio" name="genre" value="Femme" />
                  Femme</label
                >
                <label
                  ><input type="radio" name="genre" value="Autre" />
                  Autre</label
                >
              </div>
            </fieldset>
            <div class="form-row">
              <label for="tshirt">Taille de t-shirt *</label>
              <select id="tshirt" name="tshirt" required>
                <option value="" disabled selected>Choisir...</option>
                <option value="S">S</option>
                <option value="M">M</option>
                <option value="L">L</option>
                <option value="XL">XL</option>
              </select>
            </div>
            <fieldset class="form-row">
              <legend>Contact d'urgence</legend>
              <div class="form-row two-cols">
                <div class="col">
                  <label for="emergency_name">Nom et prénom *</label>
                  <input
                    id="emergency_name"
                    name="emergency_name"
                    type="text"
                    required
                  />
                </div>
                <div class="col">
                  <label for="emergency_phone">Numéro de téléphone *</label>
                  <input
                    id="emergency_phone"
                    name="emergency_phone"
                    type="tel"
                    required
                    autocomplete="tel"
                    inputmode="tel"
                    placeholder="ex: +41 79 123 45 67"
                    pattern="^\+?[0-9\s\-()]{7,20}$"
                    title="Format attendu: +41 79 123 45 67 ou 079 123 45 67"
                  />
                </div>
              </div>
            </fieldset>
            <div class="form-actions">
              <!-- Infinity-only optional Poké Bowl: single embedded box with toggle + conditional options -->
              <div class="form-row" id="poke-bowl-box" hidden>
                <label
                  >Souhaites-tu profiter d'un Poké Bowl cuisiné par Happy Bowl
                  (Sion) ?</label
                >
                <div class="choices-inline">
                  <label
                    ><input type="radio" name="poke_bowl_wants" value="Oui" />
                    Oui</label
                  >
                  <label
                    ><input type="radio" name="poke_bowl_wants" value="Non" />
                    Non</label
                  >
                </div>
                <p class="form-hint">
                  Optionnel – <span class="bowl-price">15 CHF</span>, servi le
                  jour de la course à Ardon.
                </p>
                <div class="form-row" id="poke-bowl-options" hidden>
                  <label>Choix du Poké Bowl</label>
                  <div class="choices-inline">
                    <label>
                      <input type="radio" name="poke_bowl" value="Poulet" />
                      Poulet : Riz basmati, poulet, mangue, concombre, carottes
                      et oignon frit
                    </label>
                    <label>
                      <input type="radio" name="poke_bowl" value="Poisson" />
                      Poisson : Riz basmati, saumon, avocat, chou blanc, oignon
                      rouge, ciboulette
                    </label>
                    <label>
                      <input type="radio" name="poke_bowl" value="Végé" />
                      Végé : Quinoa, falafel, chou rouge, radis, edamame, graine
                      de sésame
                    </label>
                  </div>
                </div>
              </div>
              <div class="form-row" style="margin-bottom: 12px">
                <label>
                  <input
                    type="checkbox"
                    id="agree-rules"
                    name="agree_rules"
                    required
                  />
                  J'ai lu le
                  <a href="#" class="rule-link" data-open-rules>règlement</a>
                  <span class="open-note">(aperçu PDF)</span>
                </label>
              </div>
              <!-- Upload parental authorization (shown if < 18 years) -->
              <div class="form-row" id="parental-upload-row" hidden>
                <label for="parental_doc"
                  >Autorisation parentale (PDF, JPG, PNG) *</label
                >
                <input
                  id="parental_doc"
                  name="parental_doc"
                  type="file"
                  accept=".pdf,.jpg,.jpeg,.png"
                />
                <p class="form-hint">
                  Téléchargez l'autorisation parentale signée.
                  <a
                    href="../Lettre%20d%27autorisation%20parental.pdf"
                    target="_blank"
                    rel="noopener"
                    >Télécharger le modèle</a
                  >.
                </p>
              </div>
              <button type="button" id="go-payment-btn" class="submit-btn">
                Passer au paiement
                <span class="price-tag" id="payment-price"></span>
              </button>
              <p class="form-hint">* Champs obligatoires.</p>
            </div>
          </form>
        </div>

        <!-- Section Paiement (masquée au départ) -->
        <div class="payment-section" aria-labelledby="paiement-title" hidden>
          <h2 id="paiement-title" class="form-title">Paiement</h2>
          <div class="payment-summary">
            <span class="summary-label">Format:</span>
            <strong id="payment-summary-format"></strong>
            <span class="summary-sep">•</span>
            <span class="summary-label">Prix:</span>
            <strong id="payment-summary-price"></strong>
            <span>CHF</span>
          </div>
          <p class="waitlist-note" id="waitlist-note" hidden>
            LISTE D'ATTENTE ACTIVÉE – tu es actuellement sur la liste d'attente.
            Nous te contacterons si une place se libère. Les paiements sont
            actuellement suspendus.
          </p>
          <div class="payment-choices-wrapper">
            <a
              href="#"
              class="inscription-format payment-choice-card"
              data-method="twint"
              tabindex="0"
            >
              <div class="format-content">
                <img
                  src="../images/twintlogo.png"
                  alt="TWINT"
                  class="format-logo"
                />
                <h2>TWINT</h2>

                <span class="fee-tag">+1 CHF frais</span>
              </div>
            </a>
            <a
              href="#"
              class="inscription-format payment-choice-card"
              data-method="bank"
              tabindex="0"
            >
              <div class="format-content">
                <i
                  class="fa-solid fa-building-columns format-logo icon"
                  aria-hidden="true"
                ></i>
                <h2>Virement bancaire</h2>
              </div>
            </a>
          </div>
          <div class="payment-details-wrapper" hidden>
            <div id="payment-details-twint" hidden>
              <h3>Paiement TWINT</h3>
              <div class="payment-total-highlight">
                <span id="twint-total">0</span>
                <span>CHF</span>
                <span class="fee-note">(+1 CHF frais inclus)</span>
              </div>
              <p class="payment-extras" id="twint-extras" hidden></p>
              <p class="payment-format">
                <strong id="twint-format"></strong>
              </p>
              <div class="payment-actions">
                <a
                  class="submit-btn"
                  id="twint-pay-link"
                  href="https://go.twint.ch/1/e/tw?tw=acq.zXMzIZp8TpOTjIqBPeO4PxTBKDjflBHOH9oLJo-qPOmf0Kwo0vt3nOo4FbL_Fx0u"
                  rel="noopener"
                >
                  Payer via TWINT
                </a>
              </div>
            </div>
            <div id="payment-details-bank" hidden>
              <h3>Virement bancaire</h3>
              <div class="payment-total-highlight">
                <span id="bank-total">0</span>
                <span>CHF</span>
              </div>
              <p class="payment-extras" id="bank-extras" hidden></p>
              <p class="payment-format">
                <strong id="bank-format"></strong>
              </p>
              <div class="bank-info-box">
                <ul class="payment-details">
                  <li><strong>Bénéficiaire:</strong> Backyard Ultra Valais</li>
                  <li><strong>Adresse:</strong> 1912 Leytron</li>
                  <li><strong>IBAN:</strong> CH06 8080 8007 9890 2427 1</li>
                  <li><strong>SWIFT-BIC:</strong> RAIFCH22</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Règlement Modal Preview -->
    <div class="modal-overlay" id="rules-modal" aria-hidden="true">
      <div
        class="modal-dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="rules-title"
      >
        <div class="modal-header">
          <h3 id="rules-title">Règlement – Aperçu PDF</h3>
          <button type="button" class="modal-close" aria-label="Fermer">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <iframe
            src="../Règlement%20édition%202026.PDF.pdf"
            title="Règlement PDF"
            frameborder="0"
          ></iframe>
        </div>
      </div>
    </div>

    <script>
      // Simple modal logic for règlement preview
      (function () {
        const openLinks = document.querySelectorAll("[data-open-rules]");
        const modal = document.getElementById("rules-modal");
        if (!modal) return;
        const closeBtn = modal.querySelector(".modal-close");
        const dialog = modal.querySelector(".modal-dialog");
        const overlayClickToClose = (e) => {
          if (e.target === modal) {
            hideModal();
          }
        };
        function showModal() {
          modal.setAttribute("aria-hidden", "false");
          document.body.style.overflow = "hidden";
          modal.addEventListener("click", overlayClickToClose);
          if (dialog) {
            dialog.addEventListener("click", function dialogStop(e) {
              e.stopPropagation();
            });
          }
          // Focus the close button for accessibility
          if (closeBtn) {
            closeBtn.focus();
          }
        }
        function hideModal() {
          modal.setAttribute("aria-hidden", "true");
          document.body.style.overflow = "";
          modal.removeEventListener("click", overlayClickToClose);
        }
        openLinks.forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            showModal();
          });
        });
        if (closeBtn) {
          closeBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            hideModal();
          });
        }
        // Escape key to close
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") hideModal();
        });
      })();
    </script>

    <!-- Footer (same as homepage) -->
    <footer class="footer bg-black">
      <div class="container">
        <div class="footer-grid">
          <div>
            <a href="/">
              <img src="../images/buv.png" alt="logo" />
            </a>
            <d class="copyright text-sm">
              © Backyard Ultra Valais 2026 - Suisse<br />
            </d>
          </div>
          <div>
            <h4 class="contact-headline">Contacts</h4>
            <b class="contact text-md">
              <i class="fa fa-envelope"></i> backyardultravalais@gmail.com
            </b>
          </div>
          <div></div>
          <div>
            <a
              href="https://www.instagram.com/backyard.ultra.valais/"
              target="_blank"
              rel="noopener noreferrer"
              class="social-icon"
            >
              <i class="fab fa-instagram"></i>
            </a>
            <a
              href="https://www.facebook.com/profile.php?id=61566704801123"
              target="_blank"
              rel="noopener noreferrer"
              class="social-icon"
            >
              <i class="fab fa-facebook"></i>
            </a>
          </div>
        </div>
      </div>
    </footer>

    <script src="../js/main.js"></script>
    <script>
      (function () {
        // Scope to format cards only (avoid payment cards)
        const formatLinks = document.querySelectorAll(
          ".formats-wrapper .inscription-format",
        );
        const formatsWrapper = document.querySelector(".formats-wrapper");
        const soonNote = document.querySelector(".soon-note");
        const pageHead = document.getElementById("inscriptions-title");
        const subHeadEl = document.querySelector(".sub-head");
        const formWrapper = document.querySelector(
          ".registration-form-wrapper",
        );
        const paymentSection = document.querySelector(".payment-section");
        const goPaymentBtn = document.getElementById("go-payment-btn");
        const defaultGoPaymentText = goPaymentBtn
          ? goPaymentBtn.textContent
          : "Passer au paiement";
        const selectedFormatInput = document.getElementById(
          "selected-format-input",
        );
        const selectedFormatLabel = document.querySelector(
          ".selected-format-label",
        );
        const paymentPriceSpan = document.getElementById("payment-price");
        const paymentSectionPrice = document.getElementById(
          "payment-section-price",
        );
        const summary = document.getElementById("selected-summary");
        const summaryFormat = document.getElementById("summary-format");
        const summaryPrice = document.getElementById("summary-price");
        const backBtn = document.querySelector(".back-to-formats");
        const waitlistNote = document.getElementById("waitlist-note");
        // Persist selected format & price across steps (incl. dev button)
        let currentFormatName = "";
        let currentBasePrice = 0;

        function showWaitlistOnly() {
          const choiceWrapper = document.querySelector(
            ".payment-choices-wrapper",
          );
          const detailsWrapper = document.querySelector(
            ".payment-details-wrapper",
          );
          if (choiceWrapper) choiceWrapper.hidden = true;
          if (detailsWrapper) detailsWrapper.hidden = true;
          if (waitlistNote) {
            waitlistNote.hidden = false;
            waitlistNote.style.display = "";
          }
        }

        // Dynamic pricing by date (inclusive ranges)
        function makeLocalDate(y, m, d) {
          // Use local noon to avoid DST midnight edge-cases
          return new Date(y, m - 1, d, 12, 0, 0, 0);
        }

        const PRICING = {
          INFINITY: [
            {
              label: "Early Bird",
              price: 60,
              start: makeLocalDate(2026, 1, 9),
              end: makeLocalDate(2026, 1, 31),
            },
            {
              label: "Standard",
              price: 65,
              start: makeLocalDate(2026, 2, 1),
              end: makeLocalDate(2026, 3, 7),
            },
            {
              label: "Last Chance",
              price: 70,
              start: makeLocalDate(2026, 3, 8),
              end: makeLocalDate(2026, 4, 2),
            },
          ],
          EXPLORER: [
            {
              label: "Early Bird",
              price: 35,
              start: makeLocalDate(2026, 1, 9),
              end: makeLocalDate(2026, 1, 31),
            },
            {
              label: "Standard",
              price: 40,
              start: makeLocalDate(2026, 2, 1),
              end: makeLocalDate(2026, 3, 7),
            },
            {
              label: "Last Chance",
              price: 45,
              start: makeLocalDate(2026, 3, 8),
              end: makeLocalDate(2026, 4, 2),
            },
          ],
        };

        function resolveFormatKey(name) {
          const n = String(name || "").toUpperCase();
          if (n.includes("INFINITY")) return "INFINITY";
          if (n.includes("EXPLORER")) return "EXPLORER";
          return "";
        }

        function getPriceInfo(formatName, now = new Date()) {
          const key = resolveFormatKey(formatName);
          const tiers = PRICING[key] || [];
          if (!tiers.length) return { label: "", price: 0 };
          for (const t of tiers) {
            if (now >= t.start && now <= t.end) return t;
          }
          // Fallbacks: before first → first tier; after last → last tier
          if (now < tiers[0].start) return tiers[0];
          return tiers[tiers.length - 1];
        }

        function initPaymentCards() {
          const choiceWrapper = document.querySelector(
            ".payment-choices-wrapper",
          );
          const detailsWrapper = document.querySelector(
            ".payment-details-wrapper",
          );
          const twintDetails = document.getElementById("payment-details-twint");
          const bankDetails = document.getElementById("payment-details-bank");
          const cards = document.querySelectorAll(
            ".payment-choice-card.inscription-format",
          );
          if (!choiceWrapper || !detailsWrapper || !cards.length) return;
          // Reset view
          detailsWrapper.hidden = true;
          choiceWrapper.hidden = false;
          if (formWrapper) formWrapper.hidden = true;
          if (formWrapper) formWrapper.style.display = "none";
          if (formatsWrapper) formatsWrapper.style.display = "none";
          if (soonNote) soonNote.style.display = "none";
          twintDetails && (twintDetails.hidden = true);
          bankDetails && (bankDetails.hidden = true);
          if (waitlistNote) {
            waitlistNote.hidden = true;
            waitlistNote.style.display = "none";
          }

          // If INFINITY format selected, only show waitlist note
          try {
            const fmt =
              currentFormatName ||
              (summaryFormat && summaryFormat.textContent) ||
              "";
            if (["INFINITY", "EXPLORER"].includes(resolveFormatKey(fmt))) {
              showWaitlistOnly();
              return;
            }
          } catch (_) {}
          function showDetails(method) {
            choiceWrapper.hidden = true;
            detailsWrapper.hidden = false;
            if (formWrapper) formWrapper.hidden = true;
            if (formWrapper) formWrapper.style.display = "none";
            if (formatsWrapper) formatsWrapper.style.display = "none";
            if (soonNote) soonNote.style.display = "none";
            if (waitlistNote) {
              waitlistNote.hidden = true;
              waitlistNote.style.display = "none";
            }
            // Compute and display totals and format labels
            const fmt =
              currentFormatName ||
              (summaryFormat && summaryFormat.textContent) ||
              "";
            const paySummaryPriceEl = document.getElementById(
              "payment-summary-price",
            );
            const base =
              parseFloat(
                String(paySummaryPriceEl?.textContent || "").replace(
                  /[^0-9.]/g,
                  "",
                ),
              ) ||
              0 ||
              currentBasePrice ||
              parseFloat(
                String(
                  (summaryPrice && summaryPrice.textContent) || "0",
                ).replace(/[^0-9.]/g, ""),
              ) ||
              0;
            // Add Poké Bowl fee (+15 CHF) only if INFINITY and user selected "Oui"
            const wantsBowl =
              (document.querySelector('input[name="poke_bowl_wants"]:checked')
                ?.value || "") === "Oui";
            const allowsBowl = /(INFINITY|EXPLORER)/.test(
              String(fmt).toUpperCase(),
            );
            const bowlFee = allowsBowl && wantsBowl ? 15 : 0;
            const twTotalEl = document.getElementById("twint-total");
            const bkTotalEl = document.getElementById("bank-total");
            const twFmtEl = document.getElementById("twint-format");
            const bkFmtEl = document.getElementById("bank-format");
            const twExtrasEl = document.getElementById("twint-extras");
            const bkExtrasEl = document.getElementById("bank-extras");
            const feeTwint = 1;
            const feeBank = 0;
            // Always compute both totals to avoid any 0 display
            const twTotal = Math.round(base + bowlFee + feeTwint);
            const bkTotal = Math.round(base + bowlFee + feeBank);
            if (twTotalEl) twTotalEl.textContent = String(twTotal);
            if (bkTotalEl) bkTotalEl.textContent = String(bkTotal);
            if (twFmtEl) twFmtEl.textContent = fmt;
            if (bkFmtEl) bkFmtEl.textContent = fmt;
            // Extras line for Poké Bowl under total price
            let extrasText = "";
            if (allowsBowl && wantsBowl) {
              const dish = (
                document.querySelector('input[name="poke_bowl"]:checked')
                  ?.value || ""
              ).trim();
              extrasText = `Poké Bowl${dish ? ` – ${dish}` : ""} (+15 CHF)`;
            }
            if (twExtrasEl) {
              if (extrasText) {
                twExtrasEl.textContent = extrasText;
                twExtrasEl.hidden = false;
              } else {
                twExtrasEl.hidden = true;
              }
            }
            if (bkExtrasEl) {
              if (extrasText) {
                bkExtrasEl.textContent = extrasText;
                bkExtrasEl.hidden = false;
              } else {
                bkExtrasEl.hidden = true;
              }
            }
            if (method === "twint") {
              if (twintDetails) twintDetails.hidden = false;
              if (bankDetails) bankDetails.hidden = true;
              // Bind popup window for TWINT payment
              const twLink = document.getElementById("twint-pay-link");
              if (twLink && !twLink.dataset.popupBound) {
                twLink.addEventListener("click", (e) => {
                  e.preventDefault();
                  const url = twLink.href;
                  // Compute a smaller popup anchored to the right side
                  const winX =
                    typeof window.screenX === "number" ? window.screenX : 0;
                  const winY =
                    typeof window.screenY === "number" ? window.screenY : 0;
                  const outerW =
                    typeof window.outerWidth === "number"
                      ? window.outerWidth
                      : window.innerWidth;
                  const outerH =
                    typeof window.outerHeight === "number"
                      ? window.outerHeight
                      : window.innerHeight;
                  const margin = 16;
                  const popupW = Math.max(
                    360,
                    Math.min(520, Math.floor(window.innerWidth * 0.35)),
                  );
                  const popupH = Math.max(
                    480,
                    Math.min(720, Math.floor(window.innerHeight * 0.85)),
                  );
                  let left = winX + outerW - popupW - margin;
                  let top = winY + margin;
                  // Fallbacks to keep on screen
                  if (left < 0) left = margin;
                  if (top < 0) top = margin;
                  const features = [
                    "toolbar=no",
                    "location=no",
                    "status=no",
                    "menubar=no",
                    "scrollbars=yes",
                    "resizable=yes",
                    `width=${popupW}`,
                    `height=${popupH}`,
                    `left=${left}`,
                    `top=${top}`,
                  ].join(",");
                  const w = window.open(url, "twintPayment", features);
                  if (w) {
                    try {
                      w.focus();
                    } catch (_) {}
                  }
                });
                twLink.dataset.popupBound = "1";
              }
            } else {
              if (twintDetails) twintDetails.hidden = true;
              if (bankDetails) bankDetails.hidden = false;
            }
            window.scrollTo({
              top: detailsWrapper.offsetTop - 80,
              behavior: "smooth",
            });
          }
          cards.forEach((card) => {
            const method = card.getAttribute("data-method") || "";
            card.addEventListener("click", (e) => {
              e.preventDefault();
              showDetails(method);
            });
            card.addEventListener("keypress", (e) => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                showDetails(method);
              }
            });
          });
          // Back button removed per request; payment step remains focused
        }

        function selectFormat(link) {
          const formatName = link.querySelector("h2").textContent.trim();
          // Dynamic date-based price with fallback to data-price
          const tier = getPriceInfo(formatName);
          const fallbackPrice =
            parseFloat(
              String(link.dataset.price || "").replace(/[^0-9.]/g, ""),
            ) || 0;
          const priceNum =
            typeof tier.price === "number" && tier.price > 0
              ? tier.price
              : fallbackPrice;
          const priceStr = String(priceNum);
          // Update state for later steps
          currentFormatName = formatName;
          currentBasePrice = priceNum;
          selectedFormatInput.value = formatName;
          selectedFormatLabel.textContent = formatName;
          paymentPriceSpan.textContent = priceStr + " CHF";
          if (paymentSectionPrice) paymentSectionPrice.textContent = priceStr;
          // Guard summary elements (they may be absent), avoid runtime errors
          if (summaryFormat) summaryFormat.textContent = formatName;
          if (summaryPrice) summaryPrice.textContent = priceStr;
          if (summary) summary.hidden = false;
          // Show the form: remove both hidden attribute and any inline display:none
          formWrapper.hidden = false;
          if (formWrapper) {
            try {
              formWrapper.removeAttribute("hidden");
            } catch (_) {}
            formWrapper.style.display = "";
          }
          formatsWrapper.style.display = "none";
          soonNote.style.display = "none";
          // Show Poké Bowl section for Infinity and Explorer
          // Poké Bowl: single embedded box + conditional options
          const bowlBox = document.getElementById("poke-bowl-box");
          const optionsRow = document.getElementById("poke-bowl-options");
          // Allow Poké Bowl for both INFINITY and EXPLORER
          const allowsBowl = /(INFINITY|EXPLORER)/.test(
            formatName.toUpperCase(),
          );
          if (bowlBox && optionsRow) {
            // Show only for allowed formats
            if (allowsBowl) {
              bowlBox.hidden = false;
              bowlBox.style.display = "";
              try {
                bowlBox.removeAttribute("hidden");
              } catch (_) {}
            } else {
              bowlBox.hidden = true;
              bowlBox.style.display = "none";
              try {
                bowlBox.setAttribute("hidden", "");
              } catch (_) {}
            }
            optionsRow.hidden = true;
            optionsRow.style.display = "none";
            try {
              optionsRow.setAttribute("hidden", "");
            } catch (_) {}
            // Reset and wire radios
            const wantsRadios = bowlBox.querySelectorAll(
              'input[name="poke_bowl_wants"]',
            );
            const dishRadios = optionsRow.querySelectorAll(
              'input[name="poke_bowl"]',
            );
            wantsRadios.forEach((r) => {
              r.checked = false;
              r.disabled = !allowsBowl;
              r.required = allowsBowl;
            });
            dishRadios.forEach((r) => {
              r.checked = false;
              r.required = false;
              r.disabled = !allowsBowl;
            });
            function updateOptionsVisibility() {
              const wants = bowlBox.querySelector(
                'input[name="poke_bowl_wants"]:checked',
              )?.value;
              const show = wants === "Oui";
              optionsRow.hidden = !show;
              optionsRow.style.display = show ? "" : "none";
              try {
                if (show) optionsRow.removeAttribute("hidden");
                else optionsRow.setAttribute("hidden", "");
              } catch (_) {}
              dishRadios.forEach((r) => {
                r.required = show;
                if (!show) r.checked = false;
              });
            }
            if (allowsBowl) {
              wantsRadios.forEach((r) =>
                r.addEventListener("change", updateOptionsVisibility),
              );
            }
          }
          window.scrollTo({
            top: formWrapper.offsetTop - 80,
            behavior: "smooth",
          });
        }

        // Block INFINITY registrations: show message and prevent selection
        const INFINITY_CLOSED_MSG =
          "Les inscriptions au format INFINITY sont fermées.";
        formatLinks.forEach((link) => {
          const isInfinity = (link.querySelector("h2")?.textContent || "")
            .toUpperCase()
            .includes("INFINITY");
          if (isInfinity) {
            // Visual: grey out the Infinity card
            link.classList.add("infinity-closed");
            // Reinstate disabled semantics if removed elsewhere
            try {
              link.setAttribute("aria-disabled", "true");
            } catch (_) {}
          }
          function showClosedMessage() {
            if (soonNote) {
              soonNote.textContent = INFINITY_CLOSED_MSG;
              soonNote.style.display = "";
              soonNote.style.color = "#d93025";
              soonNote.style.fontWeight = "600";
            }
          }
          // Use capture to intercept before global handlers in main.js
          link.addEventListener(
            "click",
            (e) => {
              e.preventDefault();
              if (isInfinity) {
                // Block other click handlers from running
                try {
                  e.stopImmediatePropagation();
                } catch (_) {}
                try {
                  e.stopPropagation();
                } catch (_) {}
                showClosedMessage();
                return; // Block selection
              }
              // Permettre l'ouverture même si aria-disabled = true
              selectFormat(link);
            },
            true,
          );
          link.addEventListener("keypress", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              if (isInfinity) {
                showClosedMessage();
                return; // Block selection
              }
              selectFormat(link);
            }
          });
        });

        backBtn.addEventListener("click", () => {
          formWrapper.hidden = true;
          if (formWrapper) formWrapper.style.display = "none";
          paymentSection.hidden = true;
          if (paymentSection) paymentSection.style.display = "none";
          formatsWrapper.style.display = "";
          soonNote.style.display = "";
          if (pageHead) pageHead.style.display = "";
          if (subHeadEl) subHeadEl.style.display = "";
          summary.hidden = true;
          const bowlBox = document.getElementById("poke-bowl-box");
          const optionsRow = document.getElementById("poke-bowl-options");
          if (bowlBox && optionsRow) {
            bowlBox.hidden = true;
            optionsRow.hidden = true;
            const wantsRadios = bowlBox.querySelectorAll(
              'input[name="poke_bowl_wants"]',
            );
            const dishRadios = optionsRow.querySelectorAll(
              'input[name="poke_bowl"]',
            );
            wantsRadios.forEach((r) => {
              r.checked = false;
              r.disabled = false;
              r.required = false;
            });
            dishRadios.forEach((r) => {
              r.checked = false;
              r.required = false;
              r.disabled = false;
            });
          }
          window.scrollTo({
            top: formatsWrapper.offsetTop - 80,
            behavior: "smooth",
          });
        });

        function showPaymentSection() {
          if (goPaymentBtn) {
            goPaymentBtn.disabled = false;
            goPaymentBtn.textContent = defaultGoPaymentText;
          }
          // Clear other steps: hide formats and form, hide soon note and summary
          if (formatsWrapper) formatsWrapper.style.display = "none";
          if (soonNote) soonNote.style.display = "none";
          if (summary) summary.hidden = true;
          formWrapper.hidden = true;
          if (formWrapper) formWrapper.style.display = "none";
          if (pageHead) pageHead.style.display = "none";
          if (subHeadEl) subHeadEl.style.display = "none";
          paymentSection.hidden = false;
          if (paymentSection) paymentSection.style.display = "";
          // Populate payment summary with selected format and base price
          try {
            const psFmt = document.getElementById("payment-summary-format");
            const psPrice = document.getElementById("payment-summary-price");
            const fmt = currentFormatName || summaryFormat?.textContent || "";
            const base =
              currentBasePrice ||
              parseFloat(
                String(summaryPrice?.textContent || "0").replace(
                  /[^0-9.]/g,
                  "",
                ),
              ) ||
              0;
            if (psFmt) psFmt.textContent = fmt;
            if (psPrice) psPrice.textContent = String(base);
          } catch (_) {}
          // If INFINITY format selected, show waitlist and skip methods
          try {
            const fmt = currentFormatName || summaryFormat?.textContent || "";
            if (["INFINITY", "EXPLORER"].includes(resolveFormatKey(fmt))) {
              showWaitlistOnly();
            } else {
              try {
                initPaymentCards();
              } catch (_) {}
            }
          } catch (_) {
            try {
              initPaymentCards();
            } catch (_) {}
          }
          window.scrollTo({
            top: paymentSection.offsetTop - 80,
            behavior: "smooth",
          });
        }

        // Dev payment button removed

        goPaymentBtn.addEventListener("click", () => {
          const form = document.getElementById("inscription-form");
          // Valider le formulaire avant de passer au paiement
          if (!form.checkValidity()) {
            form.reportValidity();
            return;
          }
          // Envoi au Google Apps Script avant affichage paiement
          goPaymentBtn.disabled = true;
          goPaymentBtn.textContent = "Envoi…";
          // Construire les données à envoyer (JSON). Si un fichier est présent, on l'encode en base64.
          const fd = new FormData(form);
          const consent = form.querySelector("#agree-rules")?.checked
            ? "yes"
            : "no";
          const payload = {};
          for (const [k, v] of fd.entries()) {
            if (k === "parental_doc") continue;
            payload[k] = typeof v === "string" ? v : String(v);
          }
          payload["agree_rules"] = consent;
          const fileInput = form.querySelector("#parental_doc");
          const file =
            fileInput && fileInput.files && fileInput.files[0]
              ? fileInput.files[0]
              : null;

          // Fallback si URL non configurée
          const url =
            typeof GOOGLE_SHEETS_WEB_APP_URL !== "undefined" &&
            GOOGLE_SHEETS_WEB_APP_URL
              ? GOOGLE_SHEETS_WEB_APP_URL
              : "";

          const proceedToPayment = () => {
            showPaymentSection();
          };

          if (!url) {
            console.warn(
              "GOOGLE_SHEETS_WEB_APP_URL manquant - passage direct au paiement",
            );
            proceedToPayment();
            return;
          }

          const sendPayload = (pl) => {
            fetch(url, {
              method: "POST",
              headers: { "Content-Type": "text/plain;charset=UTF-8" }, // CORS-safelisted; le serveur parse JSON même en text/plain
              body: JSON.stringify(pl),
              mode: "no-cors",
            })
              .then(() => {
                proceedToPayment();
              })
              .catch((err) => {
                console.warn("Erreur envoi formulaire", err);
                proceedToPayment();
              });
          };

          if (file) {
            const reader = new FileReader();
            reader.onload = () => {
              try {
                const result = String(reader.result || "");
                const comma = result.indexOf(",");
                const base64 = comma >= 0 ? result.slice(comma + 1) : result;
                payload.parental_doc = {
                  filename: file.name,
                  contentType: file.type || "application/octet-stream",
                  base64: base64,
                };
              } catch (e) {
                console.warn("Lecture fichier échouée", e);
              }
              sendPayload(payload);
            };
            reader.onerror = () => {
              console.warn("Impossible de lire le fichier parental_doc");
              sendPayload(payload);
            };
            reader.readAsDataURL(file);
          } else {
            // Remove Poké Bowl fields unless INFINITY and 'Oui'
            try {
              const fmt = (payload.format || "").toUpperCase();
              const wants = payload.poke_bowl_wants || "";
              const allowsBowl = /(INFINITY|EXPLORER)/.test(fmt);
              if (!allowsBowl || wants !== "Oui") {
                delete payload.poke_bowl_wants;
                delete payload.poke_bowl;
              }
            } catch (_) {}
            sendPayload(payload);
          }
        });
        // Sécurité: forcer masquage initial
        paymentSection.hidden = true;
        formWrapper.hidden = true;
      })();
    </script>
  </body>
</html>
