<!DOCTYPE html>
<html lang="fr">
  <head>
    <script>
      // Prevent navbar flash by setting class before render
      document.documentElement.classList.add("has-header-page");
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inscriptions - Backyard Ultra Valais</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Red+Hat+Text:ital,wght@0,300..700;1,300..700&family=Rubik+Dirt&family=Russo+One&family=Shippori+Antique&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
      integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="../css/index_style.css" />
    <link rel="stylesheet" href="../css/informations_style.css" />
    <link rel="stylesheet" href="../css/inscriptions_style.css" />
    <link
      rel="shortcut icon"
      href="../images/favicon.ico"
      type="image/x-icon"
    />
  </head>
  <body class="has-header inscriptions-page">
    <nav class="navbar">
      <div class="container">
        <div class="logo">
          <a href="/">
            <img src="../images/buv.png" alt="logo" />
          </a>
        </div>

        <!--Hamburger button-->
        <button id="hamburger-button" class="hamburger-button">
          <div class="hamburger-line"></div>
          <div class="hamburger-line"></div>
          <div class="hamburger-line"></div>
        </button>

        <div class="main-menu">
          <ul>
            <li>
              <a href="/">Accueil</a>
            </li>
            <li>
              <a href="/informations">Informations</a>
            </li>
            <li class="has-submenu">
              <a
                href="#"
                class="parent-link"
                aria-haspopup="true"
                aria-expanded="false"
                >Résultats</a
              >
              <ul class="dropdown-menu">
                <li><a href="/resultats/2025">2025</a></li>
                <li><a href="/resultats/2026">2026</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a
                href="#"
                class="parent-link"
                aria-haspopup="true"
                aria-expanded="false"
                >Photos</a
              >
              <ul class="dropdown-menu">
                <li><a href="/photos/2025">2025</a></li>
                <li><a href="/photos/2026">2026</a></li>
              </ul>
            </li>
            <li>
              <a href="/about-us">Notre Equipe</a>
            </li>
            <li>
              <a href="/partenaires">Partenaires</a>
            </li>
            <li class="social-nav">
              <a
                href="https://www.instagram.com/backyard.ultra.valais/"
                target="_blank"
                rel="noopener noreferrer"
                class="social-icon"
              >
                <i class="fab fa-instagram"></i>
              </a>
              <a
                href="https://www.facebook.com/profile.php?id=61566704801123"
                target="_blank"
                rel="noopener noreferrer"
                class="social-icon"
              >
                <i class="fab fa-facebook"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Mobile menu - outside navbar to avoid transparency inheritance -->
    <div class="mobile-menu">
      <button class="close-menu-button">&times;</button>
      <ul>
        <li>
          <a href="/">Accueil</a>
        </li>
        <li>
          <a href="/informations">Informations</a>
        </li>
        <li class="has-submenu">
          <a
            href="#"
            class="parent-link"
            aria-haspopup="true"
            aria-expanded="false"
            >Résultats</a
          >
          <ul class="dropdown-menu">
            <li><a href="/resultats/2025">2025</a></li>
            <li><a href="/resultats/2026">2026</a></li>
          </ul>
        </li>
        <li class="has-submenu">
          <a
            href="#"
            class="parent-link"
            aria-haspopup="true"
            aria-expanded="false"
            >Photos</a
          >
          <ul class="dropdown-menu">
            <li><a href="/photos/2025">2025</a></li>
            <li><a href="/photos/2026">2026</a></li>
          </ul>
        </li>
        <li>
          <a href="/about-us">Notre Equipe</a>
        </li>
        <li>
          <a href="/partenaires">Partenaires</a>
        </li>
        <li class="social-mobile">
          <a
            href="https://www.instagram.com/backyard.ultra.valais/"
            target="_blank"
            rel="noopener noreferrer"
            class="social-icon"
          >
            <i class="fab fa-instagram"></i>
          </a>
          <a
            href="https://www.facebook.com/profile.php?id=61566704801123"
            target="_blank"
            rel="noopener noreferrer"
            class="social-icon"
          >
            <i class="fab fa-facebook"></i>
          </a>
        </li>
      </ul>
    </div>

    <main class="inscriptions-fullscreen" role="main">
      <div class="blur-shell" aria-labelledby="inscriptions-title">
        <h1 id="inscriptions-title" class="page-head">Inscriptions 2026</h1>
        <p class="sub-head">Ouverture prochaine – choisissez votre format</p>
        <div class="formats-wrapper">
          <a
            href="#"
            class="inscription-format"
            data-img="../images/infinity.png"
            data-price="65"
            aria-disabled="true"
            tabindex="0"
          >
            <div class="format-content">
              <img
                src="../images/infinity.png"
                alt="Format Infinity"
                class="format-logo"
              />
              <h2>INFINITY</h2>
              <p>Boucles illimitées. Solo. Dernier debout.</p>
              <span class="status-tag">Bientôt</span>
            </div>
          </a>
          <a
            href="#"
            class="inscription-format"
            data-img="../images/explorer.png"
            data-price="40"
            aria-disabled="true"
            tabindex="0"
          >
            <div class="format-content">
              <img
                src="../images/explorer.png"
                alt="Format Explorer"
                class="format-logo"
              />
              <h2>EXPLORER</h2>
              <p>Format découverte sur nombre de boucles limité.</p>
              <span class="status-tag">Bientôt</span>
            </div>
          </a>
        </div>
        <p class="soon-note">
          Les inscriptions ne sont pas encore ouvertes. Les boutons sont
          inactifs.
        </p>
        <!-- Formulaire caché -->
        <div class="registration-form-wrapper" hidden>
          <button
            type="button"
            class="back-to-formats"
            aria-label="Retour aux formats"
          >
            ← Retour
          </button>
          <h2 class="form-title">
            Inscription <span class="selected-format-label"></span>
          </h2>
          <form id="inscription-form" action="#" method="post" novalidate>
            <input type="hidden" name="format" id="selected-format-input" />
            <!-- Honeypot anti-spam field (leave empty) -->
            <div
              style="
                position: absolute;
                left: -10000px;
                top: auto;
                width: 1px;
                height: 1px;
                overflow: hidden;
              "
            >
              <label for="hp">Ne pas remplir ce champ</label>
              <input
                id="hp"
                name="website"
                type="text"
                tabindex="-1"
                autocomplete="off"
              />
            </div>
            <div class="form-row">
              <label for="prenom">Prénom *</label>
              <input
                id="prenom"
                name="prenom"
                type="text"
                required
                autocomplete="given-name"
              />
            </div>
            <div class="form-row">
              <label for="nom">Nom *</label>
              <input
                id="nom"
                name="nom"
                type="text"
                required
                autocomplete="family-name"
              />
            </div>
            <div class="form-row">
              <label for="email">Email *</label>
              <input
                id="email"
                name="email"
                type="email"
                required
                autocomplete="email"
              />
            </div>
            <div class="form-row">
              <label for="birthdate">Date de naissance *</label>
              <input id="birthdate" name="birthdate" type="date" required />
            </div>
            <fieldset class="form-row">
              <legend>Genre *</legend>
              <div class="choices-inline">
                <label
                  ><input type="radio" name="genre" value="Homme" required />
                  Homme</label
                >
                <label
                  ><input type="radio" name="genre" value="Femme" />
                  Femme</label
                >
                <label
                  ><input type="radio" name="genre" value="Autre" />
                  Autre</label
                >
              </div>
            </fieldset>
            <div class="form-row">
              <label for="tshirt">Taille de t-shirt *</label>
              <select id="tshirt" name="tshirt" required>
                <option value="" disabled selected>Choisir...</option>
                <option value="S">S</option>
                <option value="M">M</option>
                <option value="L">L</option>
                <option value="XL">XL</option>
              </select>
            </div>
            <div class="form-actions">
              <div class="form-row" style="margin-bottom: 12px">
                <label>
                  <input
                    type="checkbox"
                    id="agree-rules"
                    name="agree_rules"
                    required
                  />
                  J'ai lu le
                  <a href="#" class="rule-link" data-open-rules>règlement</a>
                  <span class="open-note">(aperçu PDF)</span>
                </label>
              </div>
              <!-- Upload parental authorization (shown if < 18 years) -->
              <div class="form-row" id="parental-upload-row" hidden>
                <label for="parental_doc"
                  >Autorisation parentale (PDF, JPG, PNG) *</label
                >
                <input
                  id="parental_doc"
                  name="parental_doc"
                  type="file"
                  accept=".pdf,.jpg,.jpeg,.png"
                />
                <p class="form-hint">
                  Téléchargez l'autorisation parentale signée.
                  <a
                    href="../Lettre%20d%27autorisation%20parental.pdf"
                    target="_blank"
                    rel="noopener"
                    >Télécharger le modèle</a
                  >.
                </p>
              </div>
              <button type="button" id="go-payment-btn" class="submit-btn">
                Passer au paiement
                <span class="price-tag" id="payment-price"></span>
              </button>
              <p class="form-hint">* Champs obligatoires.</p>
            </div>
          </form>
        </div>

        <!-- Section Paiement (masquée au départ) -->
        <div class="payment-section" aria-labelledby="paiement-title" hidden>
          <h2 id="paiement-title" class="form-title">Paiement</h2>
          <p class="payment-intro">
            Le paiement est requis pour valider définitivement votre inscription
            une fois le formulaire ouvert. Deux méthodes seront proposées :
            TWINT (préféré) ou virement bancaire.
          </p>
          <p class="selected-summary" id="selected-summary" hidden>
            Format choisi : <strong id="summary-format"></strong> —
            <strong id="summary-price"></strong> CHF
          </p>
          <div class="payment-methods">
            <div class="payment-card twint">
              <h3 class="payment-heading">
                <i class="fa-brands fa-twint"></i> Paiement TWINT
              </h3>
              <p>
                Scannez le QR code ci-dessous avec votre application TWINT et
                indiquez en remarque :
                <strong>"Nom Prénom - Format"</strong> (ex:
                <em>Durand Marie - Infinity</em>).
              </p>
              <div class="twint-qr-wrapper">
                <img
                  src="../images/twintbtn.jpg"
                  alt="QR Code TWINT"
                  class="twint-qr"
                />
              </div>
              <ul class="payment-details">
                <li>
                  <strong>Montant:</strong>
                  <span id="payment-section-price">(à définir)</span> CHF
                </li>
                <li>
                  <strong>Remarque:</strong> Nom Prénom - Infinity / Explorer
                </li>
              </ul>
              <p class="payment-note">
                Validation quasi immédiate. Merci de privilégier cette méthode.
              </p>
            </div>
            <div class="payment-card bank">
              <h3 class="payment-heading">
                <i class="fa-solid fa-building-columns"></i> Virement bancaire
              </h3>
              <p>
                Si vous ne pouvez pas utiliser TWINT, effectuez un virement
                bancaire avec les informations ci-dessous. Le traitement peut
                prendre quelques jours.
              </p>
              <ul class="payment-details">
                <li><strong>Bénéficiaire:</strong> Backyard Ultra Valais</li>
                <li>
                  <strong>IBAN:</strong> CH00 0000 0000 0000 0000 0 (exemple)
                </li>
                <li><strong>Banque:</strong> (à confirmer)</li>
                <li><strong>SWIFT / BIC:</strong> (si nécessaire)</li>
                <li>
                  <strong>Communication:</strong> Nom Prénom - Infinity /
                  Explorer
                </li>
              </ul>
              <p class="payment-note">
                Veuillez vérifier que toutes les informations sont correctes.
                Remplacez les champs <em>(exemple)</em> par les données
                officielles lorsque disponibles.
              </p>
            </div>
          </div>
          <p class="payment-footer">
            En cas de question paiement:
            <a href="mailto:backyardultravalais@gmail.com"
              >backyardultravalais@gmail.com</a
            >
          </p>
        </div>
      </div>
    </main>

    <!-- Règlement Modal Preview -->
    <div class="modal-overlay" id="rules-modal" aria-hidden="true">
      <div
        class="modal-dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="rules-title"
      >
        <div class="modal-header">
          <h3 id="rules-title">Règlement – Aperçu PDF</h3>
          <button type="button" class="modal-close" aria-label="Fermer">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <iframe
            src="../Règlement%20édition%202026.PDF.pdf"
            title="Règlement PDF"
            frameborder="0"
          ></iframe>
        </div>
      </div>
    </div>

    <script>
      // Simple modal logic for règlement preview
      (function () {
        const openLinks = document.querySelectorAll("[data-open-rules]");
        const modal = document.getElementById("rules-modal");
        if (!modal) return;
        const closeBtn = modal.querySelector(".modal-close");
        const dialog = modal.querySelector(".modal-dialog");
        const overlayClickToClose = (e) => {
          if (e.target === modal) {
            hideModal();
          }
        };
        function showModal() {
          modal.setAttribute("aria-hidden", "false");
          document.body.style.overflow = "hidden";
          modal.addEventListener("click", overlayClickToClose);
          if (dialog) {
            dialog.addEventListener("click", function dialogStop(e) {
              e.stopPropagation();
            });
          }
          // Focus the close button for accessibility
          if (closeBtn) {
            closeBtn.focus();
          }
        }
        function hideModal() {
          modal.setAttribute("aria-hidden", "true");
          document.body.style.overflow = "";
          modal.removeEventListener("click", overlayClickToClose);
        }
        openLinks.forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            showModal();
          });
        });
        if (closeBtn) {
          closeBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            hideModal();
          });
        }
        // Escape key to close
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") hideModal();
        });
      })();
    </script>

    <!-- Footer (same as homepage) -->
    <footer class="footer bg-black">
      <div class="container">
        <div class="footer-grid">
          <div>
            <a href="/">
              <img src="../images/buv.png" alt="logo" />
            </a>
            <d class="copyright text-sm">
              © Backyard Ultra Valais 2026 - Suisse<br />
            </d>
          </div>
          <div>
            <h4 class="contact-headline">Contacts</h4>
            <b class="contact text-md">
              <i class="fa fa-envelope"></i> backyardultravalais@gmail.com
            </b>
          </div>
          <div></div>
          <div>
            <a
              href="https://www.instagram.com/backyard.ultra.valais/"
              target="_blank"
              rel="noopener noreferrer"
              class="social-icon"
            >
              <i class="fab fa-instagram"></i>
            </a>
            <a
              href="https://www.facebook.com/profile.php?id=61566704801123"
              target="_blank"
              rel="noopener noreferrer"
              class="social-icon"
            >
              <i class="fab fa-facebook"></i>
            </a>
          </div>
        </div>
      </div>
    </footer>

    <script src="../js/main.js"></script>
    <script>
      (function () {
        const formatLinks = document.querySelectorAll(".inscription-format");
        const formatsWrapper = document.querySelector(".formats-wrapper");
        const soonNote = document.querySelector(".soon-note");
        const formWrapper = document.querySelector(
          ".registration-form-wrapper"
        );
        const paymentSection = document.querySelector(".payment-section");
        const goPaymentBtn = document.getElementById("go-payment-btn");
        const selectedFormatInput = document.getElementById(
          "selected-format-input"
        );
        const selectedFormatLabel = document.querySelector(
          ".selected-format-label"
        );
        const paymentPriceSpan = document.getElementById("payment-price");
        const paymentSectionPrice = document.getElementById(
          "payment-section-price"
        );
        const summary = document.getElementById("selected-summary");
        const summaryFormat = document.getElementById("summary-format");
        const summaryPrice = document.getElementById("summary-price");
        const backBtn = document.querySelector(".back-to-formats");

        function selectFormat(link) {
          const formatName = link.querySelector("h2").textContent.trim();
          const price = link.dataset.price || "??";
          selectedFormatInput.value = formatName;
          selectedFormatLabel.textContent = formatName;
          paymentPriceSpan.textContent = price + " CHF";
          paymentSectionPrice.textContent = price;
          summaryFormat.textContent = formatName;
          summaryPrice.textContent = price;
          summary.hidden = false;
          formWrapper.hidden = false;
          formatsWrapper.style.display = "none";
          soonNote.style.display = "none";
          window.scrollTo({
            top: formWrapper.offsetTop - 80,
            behavior: "smooth",
          });
        }

        formatLinks.forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            // Permettre l'ouverture même si aria-disabled = true
            selectFormat(link);
          });
          link.addEventListener("keypress", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              selectFormat(link);
            }
          });
        });

        backBtn.addEventListener("click", () => {
          formWrapper.hidden = true;
          paymentSection.hidden = true;
          formatsWrapper.style.display = "";
          soonNote.style.display = "";
          summary.hidden = true;
          window.scrollTo({
            top: formatsWrapper.offsetTop - 80,
            behavior: "smooth",
          });
        });

        goPaymentBtn.addEventListener("click", () => {
          const form = document.getElementById("inscription-form");
          // Valider le formulaire avant de passer au paiement
          if (!form.checkValidity()) {
            form.reportValidity();
            return;
          }
          // Envoi au Google Apps Script avant affichage paiement
          const originalText = goPaymentBtn.textContent;
          goPaymentBtn.disabled = true;
          goPaymentBtn.textContent = "Envoi…";
          // Construire les données à envoyer (JSON). Si un fichier est présent, on l'encode en base64.
          const fd = new FormData(form);
          const consent = form.querySelector("#agree-rules")?.checked
            ? "yes"
            : "no";
          const payload = {};
          for (const [k, v] of fd.entries()) {
            if (k === "parental_doc") continue;
            payload[k] = typeof v === "string" ? v : String(v);
          }
          payload["agree_rules"] = consent;
          const fileInput = form.querySelector("#parental_doc");
          const file =
            fileInput && fileInput.files && fileInput.files[0]
              ? fileInput.files[0]
              : null;

          // Fallback si URL non configurée
          const url =
            typeof GOOGLE_SHEETS_WEB_APP_URL !== "undefined" &&
            GOOGLE_SHEETS_WEB_APP_URL
              ? GOOGLE_SHEETS_WEB_APP_URL
              : "";

          const proceedToPayment = () => {
            goPaymentBtn.disabled = false;
            goPaymentBtn.textContent = originalText;
            formWrapper.hidden = true;
            paymentSection.hidden = false;
            window.scrollTo({
              top: paymentSection.offsetTop - 80,
              behavior: "smooth",
            });
          };

          if (!url) {
            console.warn(
              "GOOGLE_SHEETS_WEB_APP_URL manquant - passage direct au paiement"
            );
            proceedToPayment();
            return;
          }

          const sendPayload = (pl) => {
            fetch(url, {
              method: "POST",
              headers: { "Content-Type": "text/plain;charset=UTF-8" }, // CORS-safelisted; le serveur parse JSON même en text/plain
              body: JSON.stringify(pl),
              mode: "no-cors",
            })
              .then(() => {
                proceedToPayment();
              })
              .catch((err) => {
                console.warn("Erreur envoi formulaire", err);
                proceedToPayment();
              });
          };

          if (file) {
            const reader = new FileReader();
            reader.onload = () => {
              try {
                const result = String(reader.result || "");
                const comma = result.indexOf(",");
                const base64 = comma >= 0 ? result.slice(comma + 1) : result;
                payload.parental_doc = {
                  filename: file.name,
                  contentType: file.type || "application/octet-stream",
                  base64: base64,
                };
              } catch (e) {
                console.warn("Lecture fichier échouée", e);
              }
              sendPayload(payload);
            };
            reader.onerror = () => {
              console.warn("Impossible de lire le fichier parental_doc");
              sendPayload(payload);
            };
            reader.readAsDataURL(file);
          } else {
            sendPayload(payload);
          }
        });
        // Sécurité: forcer masquage initial
        paymentSection.hidden = true;
        formWrapper.hidden = true;
      })();
    </script>
  </body>
</html>
